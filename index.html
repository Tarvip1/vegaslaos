<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Redirect + Fallback</title>
<style>
  body { font-family:sans-serif; display:flex; justify-content:center; align-items:center; height:100vh; background:#111; color:#fff; }
  .card { text-align:center; padding:30px; background:#222; border-radius:16px; width:min(520px,90vw);}
  .bar{margin:20px auto;width:100%;height:10px;background:#333;border-radius:999px;overflow:hidden;}
  .bar>i{display:block;height:100%;width:30%;background:#0f0;border-radius:999px;animation:move 1.8s ease-in-out infinite;}
  @keyframes move{0%{margin-left:-30%}50%{margin-left:50%}100%{margin-left:120%}}
  button{margin:10px;padding:8px 14px;border:none;border-radius:8px;background:#0f0;color:#000;cursor:pointer;}
</style>
</head>
<body>
<div class="card">
  <h1 id="title">กำลังเชื่อมต่อเซิร์ฟเวอร์…</h1>
  <div class="bar"><i></i></div>
  <div id="status" style="text-align:left; max-height:120px; overflow:auto;"></div>
  <button id="skip">ข้ามไปลิงก์ถัดไป</button>
</div>

<script>
let urls = [];
let current=0;
const TIMEOUT_MS=5000;
const statusEl=document.getElementById('status');
const titleEl=document.getElementById('title');
const skipBtn=document.getElementById('skip');

function log(msg){
  const div=document.createElement('div');
  div.innerHTML=msg;
  statusEl.appendChild(div);
  statusEl.scrollTop=statusEl.scrollHeight;
}

async function loadUrls(){
  try{
    const res = await fetch('/.netlify/functions/getUrls');
    const data = await res.json();
    urls = data.urls;
    tryNext(current);
  }catch(e){
    titleEl.textContent='ไม่สามารถโหลดลิงก์ได้';
    log('❌ '+e);
  }
}

function tryNext(i){
  if(i>=urls.length){
    titleEl.textContent='เชื่อมต่อไม่สำเร็จ';
    log('❌ ไม่มีลิงก์ที่พร้อมใช้งาน');
    return;
  }
  const url=urls[i];
  log(`⏳ กำลังลองลิงก์ ${i+1}: <a href="${url}" target="_blank">${url}</a>`);
  let timer = setTimeout(()=>{ current++; tryNext(current); }, TIMEOUT_MS);
  
  try{ window.location.href=url; }catch(e){ window.open(url,'_blank'); }

  skipBtn.onclick=()=>{ clearTimeout(timer); current++; tryNext(current); };
}

loadUrls();
</script>
</body>
</html>
